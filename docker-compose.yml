networks:
  halal_network:

services:
  frontend:
    build:
      context: ./apps/frontend
      args:
        - NEXT_PUBLIC_APP_URL=${CLIENT_URL}
        - NEXT_PUBLIC_API_URL=${API_URL}
        - NEXT_PUBLIC_IMAGE_URL=${IMAGE_URL}
        - NEXT_PUBLIC_VAPID_PUBLIC_KEY=${VAPID_PUBLIC_KEY}
    container_name: halal_market_frontend
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - halal_network

  backend:
    build:
      context: ./apps/backend
    container_name: halal_market_backend
    entrypoint: /entrypoint.sh
    command: ['make', '-f', 'Makefile.docker', 'run']
    env_file:
      - .env
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      image-server:
        condition: service_healthy
    volumes:
      - ./apps/backend:/app
      - ./data/static:/data/staticfiles
      - ./data/media:/data/media
    networks:
      - halal_network
    healthcheck:
      test: ['CMD', 'python', 'app/manage.py', 'check']
      interval: 30s
      timeout: 10s
      retries: 3

  celery:
    image: halalmarket-backend
    command: ['make', '-f', 'Makefile.docker', 'celeryrun']
    container_name: halal_market_celery
    env_file:
      - .env
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - halal_network
    healthcheck:
      test: ['CMD-SHELL', 'celery -A config inspect ping']
      interval: 30s
      timeout: 10s
      retries: 3

  postgres:
    image: postgres:17-alpine
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    container_name: halal_market_postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./data/pg_backups:/root/backups
    networks:
      - halal_network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}']
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7
    container_name: halal_market_redis
    volumes:
      - redis_data:/data
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    command: ['redis-server', '--requirepass', '${REDIS_PASSWORD}']
    networks:
      - halal_network
    healthcheck:
      test: ['CMD-SHELL', 'redis-cli -a ${REDIS_PASSWORD} ping']
      interval: 10s
      timeout: 5s
      retries: 5

  image-server:
    build:
      context: ./apps/image-server
    container_name: halal_market_image_server
    volumes:
      - ./data/media:/data/media
      - ./data/cache:/data/cache
    environment:
      - MEDIA_DIR=/data/media
      - CACHE_DIR=/data/cache
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - halal_network
    healthcheck:
      test:
        [
          'CMD',
          'wget',
          '--quiet',
          '--tries=1',
          '--spider',
          'http://localhost:3030/health'
        ]
      interval: 30s
      timeout: 10s
      retries: 3

  nginx:
    image: nginx:stable-alpine
    container_name: halal_market_nginx
    ports:
      - '8000:80'
    volumes:
      - ./nginx/nginx.docker.conf:/etc/nginx/conf.d/default.conf
      - ./data/static:/data/staticfiles:ro
      - ./data/media:/data/media:ro
    depends_on:
      backend:
        condition: service_healthy
      image-server:
        condition: service_healthy
    networks:
      - halal_network
    healthcheck:
      test:
        [
          'CMD',
          'wget',
          '--quiet',
          '--tries=1',
          '--spider',
          'http://localhost/api/health/'
        ]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_data:
  redis_data:
